<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registered Rooms</title>
  <style>
    :root {
      --primary-color: #d92323;
      --secondary-color: #ffcc00;
      --background-color: #f5f5f5;
      --text-color: #333;
      --danger-color: #dc3545;
      --edit-color: #28a745;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 15px 20px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { font-size: 2em; }
    .navigation-buttons { margin-bottom: 20px; }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s;
      margin-right: 10px;
    }
    .nav-button {
      background-color: var(--secondary-color);
      color: var(--text-color);
    }
    .nav-button:hover { background-color: #e6b800; }
    .room-list-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .room-item {
      border-bottom: 1px solid #eee;
      padding: 15px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .room-item:last-child { border-bottom: none; }
    .room-details { flex-grow: 1; }
    .room-details p { margin-bottom: 5px; }
    .room-details strong { color: var(--primary-color); }
    .room-actions button {
      margin-left: 10px;
      color: white;
    }
    .edit-button { background-color: var(--edit-color); }
    .edit-button:hover { background-color: #218838; }
    .delete-button { background-color: var(--danger-color); }
    .delete-button:hover { background-color: #c82333; }
    #loadingMessage { text-align: center; padding: 20px; font-style: italic; }
    @media (max-width: 600px) {
      .room-item { flex-direction: column; align-items: flex-start; }
      .room-actions { margin-top: 10px; width: 100%; }
      .room-actions button { width: calc(50% - 5px); }
      .room-actions button:first-child { margin-right: 10px; margin-left: 0;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Registered Rooms</h1>
    </header>

    <div class="navigation-buttons">
<button class="nav-button" onclick="window.location.href='Room.html'">Back to Room Registration</button>
    </div>

    <div class="room-list-container">
      <div id="roomList">
        <!-- Room items will be injected here by JavaScript -->
      </div>
      <p id="loadingMessage">Loading rooms...</p>
    </div>
  </div>

  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      deleteDoc,
      onSnapshot // For real-time updates
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // IMPORTANT: Copy your Firebase config object here!
    const firebaseConfig = {
      apiKey: "AIzaSyDeqxzp_-kKjM3hPr6CLGfTn38e4swSKbo", // From your room_registration.html
      authDomain: "room-management-system-8e899.firebaseapp.com",
      projectId: "room-management-system-8e899",
      storageBucket: "room-management-system-8e899.appspot.com",
      messagingSenderId: "667821278853",
      appId: "1:667821278853:web:a3a80c985073772670cbec"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const roomListDiv = document.getElementById('roomList');
    const loadingMessage = document.getElementById('loadingMessage');

    // Function to render rooms to the DOM
    function renderRooms(querySnapshot) {
      roomListDiv.innerHTML = ''; // Clear existing list
      if (querySnapshot.empty) {
        loadingMessage.textContent = 'No rooms registered yet.';
        loadingMessage.style.display = 'block';
        return;
      }

      querySnapshot.forEach((docSnap) => {
        const room = docSnap.data();
        const roomId = docSnap.id;
        const roomElement = document.createElement('div');
        roomElement.classList.add('room-item');
        // Using standard string concatenation or careful template literals
        roomElement.innerHTML =
          '<div class="room-details">' +
            '<p><strong>Name:</strong> ' + escapeHTML(room.roomName) + '</p>' +
            '<p><strong>Day:</strong> ' + escapeHTML(room.day) + '</p>' +
            '<p><strong>Time:</strong> ' + escapeHTML(room.time) + '</p>' +
            '<p><strong>Capacity:</strong> ' + escapeHTML(String(room.capacity)) + ' students</p>' +
          '</div>' +
          '<div class="room-actions">' +
            '<button class="edit-button" data-id="' + escapeHTML(roomId) + '" data-roomname="' + escapeHTML(room.roomName) + '" data-day="' + escapeHTML(room.day) + '" data-time="' + escapeHTML(room.time) + '" data-capacity="' + escapeHTML(String(room.capacity)) + '">Edit</button>' +
            '<button class="delete-button" data-id="' + escapeHTML(roomId) + '">Delete</button>' +
          '</div>';
        roomListDiv.appendChild(roomElement);
      });
      loadingMessage.style.display = 'none';
      attachActionListeners();
    }
    
    // Helper function to escape HTML to prevent XSS
    function escapeHTML(str) {
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }


    // Function to set up real-time listener for rooms
    function listenForRooms() {
      loadingMessage.textContent = 'Loading rooms...';
      loadingMessage.style.display = 'block';

      const roomsCollectionRef = collection(db, "rooms");
      onSnapshot(roomsCollectionRef, (querySnapshot) => {
        renderRooms(querySnapshot);
      }, (error) => {
        console.error("Error listening for room updates: ", error);
        loadingMessage.textContent = 'Failed to load rooms in real-time. Please try refreshing.';
      });
    }

    // Function to attach event listeners to edit and delete buttons
    function attachActionListeners() {
      const editButtons = document.querySelectorAll('.edit-button');
      editButtons.forEach(button => {
        button.addEventListener('click', handleEdit);
      });

      const deleteButtons = document.querySelectorAll('.delete-button');
      deleteButtons.forEach(button => {
        button.addEventListener('click', handleDelete);
      });
    }

    // Handle Edit
    function handleEdit(event) {
      const button = event.target;
      const queryParams = new URLSearchParams({
        edit: 'true',
        id: button.dataset.id,
        roomName: button.dataset.roomname,
        day: button.dataset.day,
        time: button.dataset.time,
        capacity: button.dataset.capacity
      });
      window.location.href = 'room_registration.html?' + queryParams.toString();
    }

    // Handle Delete
    async function handleDelete(event) {
      const roomId = event.target.dataset.id;
      if (confirm('Are you sure you want to delete this room?')) {
        try {
          await deleteDoc(doc(db, "rooms", roomId));
          // No need to call fetchAndDisplayRooms() here if using onSnapshot,
          // as the list will update automatically.
          alert('Room deleted successfully!');
        } catch (error) {
          console.error("Error deleting room: ", error);
          alert('Failed to delete room. Please try again.');
        }
      }
    }

    // Initial call to listen for rooms when the page loads
    document.addEventListener('DOMContentLoaded', listenForRooms);
  </script>
</body>
</html>
