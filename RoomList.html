<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registered Rooms</title>
  <style>
    :root {
      --primary-color: #d92323;
      --secondary-color: #ffcc00;
      --background-color: #f5f5f5;
      --text-color: #333;
      --danger-color: #dc3545;
      --edit-color: #28a745;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 15px 20px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { font-size: 2em; }
    .navigation-buttons { margin-bottom: 20px; }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s;
      margin-right: 10px;
    }
    .nav-button {
      background-color: var(--secondary-color);
      color: var(--text-color);
    }
    .nav-button:hover { background-color: #e6b800; }
    .room-list-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .room-item {
      border-bottom: 1px solid #eee;
      padding: 15px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .room-item:last-child { border-bottom: none; }
    .room-details { flex-grow: 1; }
    .room-details p { margin-bottom: 5px; }
    .room-details strong { color: var(--primary-color); }
    .room-actions button {
      margin-left: 10px;
      color: white;
    }
    .edit-button { background-color: var(--edit-color); }
    .edit-button:hover { background-color: #218838; }
    .delete-button { background-color: var(--danger-color); }
    .delete-button:hover { background-color: #c82333; }
    .status-used {
        color: var(--danger-color); /* Or a green for 'in use' if preferred */
        font-weight: bold;
    }

    .status-free {
        color: #28a745; /* Green for 'free' */
        font-weight: bold;
    }
    #loadingMessage { text-align: center; padding: 20px; font-style: italic; }
    @media (max-width: 600px) {
      .room-item { flex-direction: column; align-items: flex-start; }
      .room-actions { margin-top: 10px; width: 100%; }
      .room-actions button { width: calc(50% - 5px); }
      .room-actions button:first-child { margin-right: 10px; margin-left: 0;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Registered Rooms</h1>
    </header>

    <div class="navigation-buttons">
      <button class="nav-button" onclick="window.location.href='Room.html'">Back to Room Registration</button>
    </div>

    <div class="room-list-container">
      <div id="roomList">
        <!-- Room items will be injected here by JavaScript -->
      </div>
      <p id="loadingMessage">Loading rooms...</p>
    </div>
  </div>

  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      // doc, // Not directly used for deleting/editing rooms in this revised version
      // deleteDoc, // Removed for this version
      onSnapshot // For real-time updates
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // IMPORTANT: Copy your Firebase config object here!
    const firebaseConfig = {
      apiKey: "AIzaSyDeqxzp_-kKjM3hPr6CLGfTn38e4swSKbo", 
      authDomain: "room-management-system-8e899.firebaseapp.com",
      projectId: "room-management-system-8e899",
      storageBucket: "room-management-system-8e899.appspot.com",
      messagingSenderId: "667821278853",
      appId: "1:667821278853:web:a3a80c985073772670cbec"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const roomListDiv = document.getElementById('roomList');
    const loadingMessage = document.getElementById('loadingMessage');

    // Define all available rooms and their capacities
    // This should be consistent with the one in Instructor.html
    const allCampusRooms = [
        { name: "CL1 (Computer Laboratory 1)", capacity: 30 },
        { name: "CL2 (Computer Laboratory 2)", capacity: 35 },
        { name: "CL3 (Computer Laboratory 3)", capacity: 30 },
        { name: "MDH (Multi-Disciplinary Hall)", capacity: 100 },
        { name: "AVR (Audio-Visual Room)", capacity: 50 },
        { name: "Room 201", capacity: 40 },
        { name: "Room 202", capacity: 40 },
        { name: "Room 203", capacity: 35 },
        { name: "Room 301", capacity: 45 },
        { name: "Room 302", capacity: 25 }
    ];
    
    // Helper function to escape HTML to prevent XSS (Keep as is)
    function escapeHTML(str) {
        if (str === null || str === undefined) return '';
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(String(str))); // Ensure str is a string
        return div.innerHTML;
    }

    // MODIFIED: Function to render room usage status
    function renderRoomUsage(instructorSchedulesSnapshot) {
      roomListDiv.innerHTML = ''; // Clear existing list
      
      const roomUsageCounts = {}; // { roomName: count }

      instructorSchedulesSnapshot.forEach((docSnap) => {
        const schedule = docSnap.data();
        if (schedule.roomName) {
          roomUsageCounts[schedule.roomName] = (roomUsageCounts[schedule.roomName] || 0) + 1;
        }
      });

      if (allCampusRooms.length === 0) {
        loadingMessage.textContent = 'No campus rooms defined in the script.';
        loadingMessage.style.display = 'block';
        return;
      }

      allCampusRooms.forEach((room) => {
        const usageCount = roomUsageCounts[room.name] || 0;
        const roomElement = document.createElement('div');
        roomElement.classList.add('room-item');
        
        let statusText = 'Free';
        let statusClass = 'status-free'; // You'll need to define .status-free and .status-used in CSS

        if (usageCount > 0) {
          statusText = 'In Use';
          statusClass = 'status-used';
        }

        // Display basic room info and its usage status
        roomElement.innerHTML = 
          '<div class="room-details">' +
            '<p><strong>Name:</strong> ' + escapeHTML(room.name) + '</p>' +
            '<p><strong>Capacity:</strong> ' + escapeHTML(room.capacity) + ' students</p>' +
            '<p><strong>Status:</strong> <span class="' + statusClass + '">' + escapeHTML(statusText) + '</span></p>' +
            '<p><strong>Scheduled Classes:</strong> ' + escapeHTML(usageCount) + '</p>' +
          '</div>' +
          '<div class="room-actions">' +
            // Edit/Delete buttons for room *definitions* are complex here.
            // For now, we're just showing usage based on instructor schedules.
            // '<button class="view-schedule-button" data-roomname="' + escapeHTML(room.name) + '">View Schedule</button>' + // Future enhancement
          '</div>';
        roomListDiv.appendChild(roomElement);
      });
      loadingMessage.style.display = 'none';
      // attachActionListeners(); // Re-evaluate if action listeners are needed for this view
    }

    // MODIFIED: Function to listen for instructor schedules
    function listenForRoomUsage() {
      loadingMessage.textContent = 'Loading room usage...';
      loadingMessage.style.display = 'block';

      // Listen to the 'instructors' collection
      const instructorsCollectionRef = collection(db, "instructors"); 
      onSnapshot(instructorsCollectionRef, (querySnapshot) => {
        renderRoomUsage(querySnapshot);
      }, (error) => {
        console.error("Error listening for instructor schedules: ", error);
        loadingMessage.textContent = 'Failed to load room usage. Please try refreshing.';
      });
    }

    // Remove or comment out attachActionListeners, handleEdit, handleDelete if not managing room *definitions* here
    /*
    function attachActionListeners() {
      // ... (original code for edit/delete if they were for "rooms" collection)
    }

    function handleEdit(event) {
      // ...
    }

    async function handleDelete(event) {
      // ...
    }
    */

    // Initial call to listen for instructor schedules to determine room usage
    document.addEventListener('DOMContentLoaded', listenForRoomUsage);
  </script>
</body>
</html>
