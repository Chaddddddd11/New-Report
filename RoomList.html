<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registered Rooms</title>
  <style>
    :root {
      --primary-color: #d92323;
      --secondary-color: #ffcc00;
      --background-color: #f5f5f5;
      --text-color: #333;
      --danger-color: #dc3545;
      --edit-color: #28a745;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 15px 20px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { font-size: 2em; }
    .navigation-buttons { margin-bottom: 20px; }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s;
      margin-right: 10px;
    }
    .nav-button {
      background-color: var(--secondary-color);
      color: var(--text-color);
    }
    .nav-button:hover { background-color: #e6b800; }
    .room-list-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .room-item {
      border-bottom: 1px solid #eee;
      padding: 15px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .room-item:last-child { border-bottom: none; }
    .room-details { flex-grow: 1; }
    .room-details p { margin-bottom: 5px; }
    .room-details strong { color: var(--primary-color); }
    .room-actions button {
      margin-left: 10px;
      color: white;
    }
    .edit-button { background-color: var(--edit-color); }
    .edit-button:hover { background-color: #218838; }
    .delete-button { background-color: var(--danger-color); }
    .delete-button:hover { background-color: #c82333; }
    .status-used {
        color: var(--danger-color); /* Or a green for 'in use' if preferred */
        font-weight: bold;
    }

    .status-free {
        color: #28a745; /* Green for 'free' */
        font-weight: bold;
    }
    #loadingMessage { text-align: center; padding: 20px; font-style: italic; }
    /* Modal Styles */
    .modal {
      position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe; margin: 5% auto; padding: 20px;
      border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px;
    }
    .close-button {
      color: #aaa; float: right; font-size: 28px; font-weight: bold;
    }
    .close-button:hover, .close-button:focus {
      color: black; text-decoration: none; cursor: pointer;
    }
    .modal-content div { margin-bottom: 15px; }
    .modal-content label { display: block; margin-bottom: 5px; }
    .modal-content input[type="text"], .modal-content input[type="number"] {
      width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 5px;
    }
    .modal-content button {
        background-color: var(--primary-color); color: white; padding: 10px 15px;
        border: none; border-radius: 5px; cursor: pointer; font-size: 1em;
    }
    .modal-content button:hover { background-color: #b81e1e; }
    @media (max-width: 600px) {
      .room-item { flex-direction: column; align-items: flex-start; }
      .room-actions { margin-top: 10px; width: 100%; }
      .room-actions button { width: calc(50% - 5px); }
      .room-actions button:first-child { margin-right: 10px; margin-left: 0;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Registered Rooms</h1>
    </header>

    <div class="navigation-buttons">
      <button class="nav-button" onclick="window.location.href='Room.html'">Back to Room Registration</button>
    </div>

    <div class="room-list-container">
      <div id="roomList">
        <!-- Room items will be injected here by JavaScript -->
      </div>
      <p id="loadingMessage">Loading rooms...</p>
    </div>

    <!-- Modal for Editing Room -->
    <div id="editRoomModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-button" onclick="closeEditModal()">&times;</span>
        <h2>Edit Room</h2>
        <input type="hidden" id="editRoomId">
        <div>
          <label for="editRoomName">Room Name:</label>
          <input type="text" id="editRoomName" required>
        </div>
        <div>
          <label for="editRoomCapacity">Capacity:</label>
          <input type="number" id="editRoomCapacity" required>
        </div>
        <button onclick="saveRoomChanges()">Save Changes</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc, 
      deleteDoc,
      updateDoc, // Added for editing
      onSnapshot,
      query // Added for querying rooms collection
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // IMPORTANT: Copy your Firebase config object here!
    const firebaseConfig = {
      apiKey: "AIzaSyDeqxzp_-kKjM3hPr6CLGfTn38e4swSKbo", 
      authDomain: "room-management-system-8e899.firebaseapp.com",
      projectId: "room-management-system-8e899",
      storageBucket: "room-management-system-8e899.appspot.com",
      messagingSenderId: "667821278853",
      appId: "1:667821278853:web:a3a80c985073772670cbec"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const roomListDiv = document.getElementById('roomList');
    const loadingMessage = document.getElementById('loadingMessage');

    const roomsCollectionRef = collection(db, "rooms");
    const instructorsCollectionRef = collection(db, "instructors"); // To check room usage

    // Helper function to escape HTML to prevent XSS (Keep as is)
    function escapeHTML(str) {
        if (str === null || str === undefined) return '';
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(String(str))); // Ensure str is a string
        return div.innerHTML;
    }

    // Function to render rooms from Firebase and their usage
    function renderRoomsAndUsage(roomsSnapshot, instructorSchedulesSnapshot) {
      roomListDiv.innerHTML = ''; // Clear existing list
      loadingMessage.style.display = 'none';

      const roomUsageCounts = {}; // { roomName: count }
      instructorSchedulesSnapshot.forEach((docSnap) => {
        const schedule = docSnap.data();
        if (schedule.roomName) { // Assuming room name is stored in instructor schedules
          roomUsageCounts[schedule.roomName] = (roomUsageCounts[schedule.roomName] || 0) + 1;
        }
      });

      if (roomsSnapshot.empty) {
        loadingMessage.textContent = 'No rooms found in the database. Please register rooms first.';
        loadingMessage.style.display = 'block';
        return;
      }

      roomsSnapshot.forEach((roomDoc) => {
        const room = roomDoc.data();
        const roomId = roomDoc.id;
        // Assuming room documents have 'name' and 'capacity' fields.
        // If your fields are different, please adjust room.name and room.capacity below.
        const roomName = room.name || 'Unnamed Room'; 
        const roomCapacity = room.capacity || 'N/A';

        const usageCount = roomUsageCounts[roomName] || 0;
        const roomElement = document.createElement('div');
        roomElement.classList.add('room-item');
        
        let statusText = 'Free';
        let statusClass = 'status-free';

        if (usageCount > 0) {
          statusText = 'In Use';
          statusClass = 'status-used';
        }

        roomElement.innerHTML = 
          `<div class="room-details">
            <p><strong>Name:</strong> ${escapeHTML(roomName)}</p>
            <p><strong>Capacity:</strong> ${escapeHTML(roomCapacity.toString())} students</p>
            <p><strong>Status:</strong> <span class="${statusClass}">${escapeHTML(statusText)}</span></p>
            <p><strong>Scheduled Classes:</strong> ${escapeHTML(usageCount.toString())}</p>
          </div>
          <div class="room-actions">
            <button class="edit-button" data-id="${roomId}" data-name="${escapeHTML(roomName)}" data-capacity="${escapeHTML(roomCapacity.toString())}">Edit</button>
            <button class="delete-button" data-id="${roomId}">Delete</button>
          </div>`;
        
        roomListDiv.appendChild(roomElement);

        // Add event listeners for edit and delete buttons
        roomElement.querySelector('.edit-button').addEventListener('click', function() {
            openEditModal(this.dataset.id, this.dataset.name, this.dataset.capacity);
        });
        roomElement.querySelector('.delete-button').addEventListener('click', function() {
            handleDeleteRoom(this.dataset.id);
        });
      }); // End of roomsSnapshot.forEach
    } // End of renderRoomsAndUsage function

    // Modal functions
    const editModal = document.getElementById('editRoomModal');
    const editRoomIdInput = document.getElementById('editRoomId');
    const editRoomNameInput = document.getElementById('editRoomName');
    const editRoomCapacityInput = document.getElementById('editRoomCapacity');

    window.openEditModal = (id, name, capacity) => {
        editRoomIdInput.value = id;
        editRoomNameInput.value = name;
        editRoomCapacityInput.value = capacity;
        editModal.style.display = 'block';
    };

    window.closeEditModal = () => {
        editModal.style.display = 'none';
    };

    window.saveRoomChanges = async () => {
        const id = editRoomIdInput.value;
        const name = editRoomNameInput.value.trim();
        const capacity = parseInt(editRoomCapacityInput.value, 10);

        if (!name || isNaN(capacity) || capacity <= 0) {
            alert('Please enter a valid room name and capacity.');
            return;
        }

        const roomRef = doc(db, "rooms", id);
        try {
            await updateDoc(roomRef, {
                name: name,
                capacity: capacity
            });
            alert('Room updated successfully!');
            closeEditModal();
            // Real-time listener will update the UI
        } catch (error) {
            console.error("Error updating room: ", error);
            alert('Error updating room. Check console.');
        }
    };

    // Delete room function
    window.handleDeleteRoom = async (roomId) => {
        if (confirm('Are you sure you want to delete this room? This action cannot be undone.')) {
            const roomRef = doc(db, "rooms", roomId);
            try {
                await deleteDoc(roomRef);
                alert('Room deleted successfully!');
                // Real-time listener will update the UI
            } catch (error) {
                console.error("Error deleting room: ", error);
                alert('Error deleting room. Check console.');
            }
        }
    };

    // Fetch rooms and instructor schedules to determine usage
    // We use two separate onSnapshot listeners and combine their results
    let currentRoomsSnapshot = null;
    let currentInstructorsSnapshot = null;

    onSnapshot(query(roomsCollectionRef), (roomsSnapshot) => {
        currentRoomsSnapshot = roomsSnapshot;
        if (currentInstructorsSnapshot) {
            renderRoomsAndUsage(currentRoomsSnapshot, currentInstructorsSnapshot);
        }
    }, (error) => {
        console.error("Error fetching rooms: ", error);
        loadingMessage.textContent = 'Error loading rooms data.';
        loadingMessage.style.display = 'block';
    });

    onSnapshot(query(instructorsCollectionRef), (instructorsSnapshot) => {
        currentInstructorsSnapshot = instructorsSnapshot;
        if (currentRoomsSnapshot) {
            renderRoomsAndUsage(currentRoomsSnapshot, currentInstructorsSnapshot);
        }
    }, (error) => {
        console.error("Error fetching instructor schedules: ", error);
        loadingMessage.textContent = 'Error loading room usage data.';
        loadingMessage.style.display = 'block';
    });
  </script>
      if (confirm('Are you sure you want to delete this room?')) {
        try {
          await deleteDoc(doc(db, "rooms", roomId));
          // No need to call fetchAndDisplayRooms() here if using onSnapshot,
          // as the list will update automatically.
          alert('Room deleted successfully!');
        } catch (error) {
          console.error("Error deleting room: ", error);
          alert('Failed to delete room. Please try again.');
        }
      }
    }

    // Initial call to listen for rooms when the page loads
    document.addEventListener('DOMContentLoaded', listenForRooms);
  </script>
</body>
</html>
