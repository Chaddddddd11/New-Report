<!DOCTYPE html>
<html>
<head>
  <title>DHVSU Scheduling System</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h2>DHVSU Automatic Scheduling System</h2>
  
  <div class="form-group">
    <label for="course">Select Course:</label> 
    <select id="course">
      <option value="">-- Select Course --</option>
    </select>
  </div>

  <div class="form-group">
    <label for="year">Select Year:</label> 
    <select id="year" disabled>
      <option value="">-- Select Year --</option>
    </select>
  </div>

  <div class="form-group">
    <label for="section">Select Section:</label> 
    <select id="section" disabled>
      <option value="">-- Select Section --</option>
    </select>
  </div>

  <div id="selectionSummary" class="summary">
    <span id="courseSummary">----</span>
    <span>Students Capacity:</span>
    <span id="studentCapacityDisplay">---</span>
    <span>Students</span>
  </div>

  <div id="scheduleContainer">
    <h3>Class Schedule</h3>
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>Monday</th>
          <th>Tuesday</th>
          <th>Wednesday</th>
          <th>Thursday</th>
          <th>Friday</th>
          <th>Saturday</th>
        </tr>
      </thead>
      <tbody id="scheduleBody">
      </tbody>
    </table>
  </div>

  <div class="navigation">
    <button onclick="navigateTo('instructor.html')">Instructor Enrollment</button>
    <button onclick="navigateTo('room.html')">Room Registration</button>
  </div>

  <script src="data.js"></script>
  <script src="schedule.js"></script>
  <script>
    // ... existing code ...

    function autoFillSchedule() {
      const timeSlots = generateTimeSlots();
      const selectedCourse = courseSelect.value;
      const selectedYear = yearSelect.value;
      const selectedSection = sectionSelect.value;
      
      scheduleBody.innerHTML = '';

      // Get instructors from localStorage
      const instructors = JSON.parse(localStorage.getItem('instructors')) || [];
      // Get rooms data from localStorage
      const roomsData = JSON.parse(localStorage.getItem('rooms')) || [];

      timeSlots.forEach(timeSlot => {
        const row = document.createElement('tr');
        const [startTime] = timeSlot.split('-');
        
        // First add the time column
        row.innerHTML = `<td>${timeSlot}</td>`;

        // Add cells for each day
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        days.forEach(day => {
          const cell = document.createElement('td');

          // Only show instructors if course, year, and section are selected
          if (selectedCourse && selectedYear && selectedSection) {
            // Check if there's an instructor scheduled for this time slot and day
            const scheduledInstructor = instructors.find(instructor => {
              // Match the exact course, year, and section
              if (instructor.course !== selectedCourse ||
                  instructor.year !== selectedYear ||
                  instructor.section !== selectedSection ||
                  instructor.day !== day) {
                  return false;
              }

              // Parse instructor's time range
              const [instrStartTime] = instructor.time.split(' - ')[0].split(':');
              const [instrEndTime] = instructor.time.split(' - ')[1].split(':');
              const currentHour = startTime.split(':')[0];

              // Check if this time slot falls within the instructor's schedule
              return parseInt(currentHour) >= parseInt(instrStartTime) &&
                     parseInt(currentHour) < parseInt(instrEndTime);
            });

            if (scheduledInstructor) { 
              let roomDisplay = 'TBA'; // Default to TBA
              // Check if a room is assigned to the instructor
              if (scheduledInstructor.room && scheduledInstructor.room.trim() !== '') {
                // Find the room details in roomsData using roomName
                const roomDetail = roomsData.find(r => r.roomName === scheduledInstructor.room);
                if (roomDetail) {
                  // Display room name and its capacity
                  roomDisplay = `${roomDetail.roomName} (Cap: ${roomDetail.capacity || 'N/A'})`;
                } else {
                  // Room is assigned to instructor, but not found in roomsData or capacity missing
                  roomDisplay = `${scheduledInstructor.room} (Cap: ??)`; 
                }
              }

              cell.className = 'occupied-cell';
              cell.innerHTML = `
                <div class="schedule-info">
                  <div class="instructor">${scheduledInstructor.name}</div>
                  <div class="subject">${scheduledInstructor.subject}</div>
                  <div class="room">${roomDisplay}</div>
                </div>
              `;
            } 
          }

          row.appendChild(cell);
        });

        scheduleBody.appendChild(row);
      });
    }

const yearSelect = document.getElementById('year');
const sectionSelect = document.getElementById('section');
const courseSummary = document.getElementById('courseSummary');
const studentCapacityDisplay = document.getElementById('studentCapacityDisplay');
const scheduleBody = document.getElementById('scheduleBody');

function navigateTo(page) {
  try {
    window.location.href = page;
  } catch (error) {
    console.error('Navigation error:', error);
    alert('Unable to navigate. Please check the page exists.');
  }
}

function generateTimeSlots() {
  return [
    '7:00-8:00', '8:00-9:00', '9:00-10:00', '10:00-11:00',
    '11:00-12:00', '12:00-13:00', '13:00-14:00', '14:00-15:00',
    '15:00-16:00', '16:00-17:00', '17:00-18:00', '18:00-19:00'
  ];
}

function autoFillSchedule() {
  const timeSlots = generateTimeSlots();
  const selectedCourse = courseSelect.value;
  const selectedYear = yearSelect.value;
  const selectedSection = sectionSelect.value;
  
  scheduleBody.innerHTML = '';

  const instructors = JSON.parse(localStorage.getItem('instructors')) || [];
  const roomsData = JSON.parse(localStorage.getItem('rooms')) || [];

  timeSlots.forEach(timeSlot => {
    const row = document.createElement('tr');
    const [startTime] = timeSlot.split('-');
    
    row.innerHTML = `<td>${timeSlot}</td>`;

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    days.forEach(day => {
      const cell = document.createElement('td');

      if (selectedCourse && selectedYear && selectedSection) {
        const scheduledInstructor = instructors.find(instructor => {
          if (instructor.course !== selectedCourse ||
              instructor.year !== selectedYear ||
              instructor.section !== selectedSection ||
              instructor.day !== day) {
            return false;
          }

          const [instrStartTime] = instructor.time.split(' - ')[0].split(':');
          const [instrEndTime] = instructor.time.split(' - ')[1].split(':');
          const currentHour = startTime.split(':')[0];

          return parseInt(currentHour) >= parseInt(instrStartTime) &&
                 parseInt(currentHour) < parseInt(instrEndTime);
        });

        if (scheduledInstructor) {
          let roomDisplay = 'TBA'; // Default to TBA
          // Check if a room is assigned to the instructor
          if (scheduledInstructor.room && scheduledInstructor.room.trim() !== '') {
            // Find the room details in roomsData using roomName
            const roomDetail = roomsData.find(r => r.roomName === scheduledInstructor.room);
            if (roomDetail) {
              // Display room name and its capacity
              roomDisplay = `${roomDetail.roomName} (Cap: ${roomDetail.capacity || 'N/A'})`;
            } else {
              // Room is assigned to instructor, but not found in roomsData or capacity missing
              roomDisplay = `${scheduledInstructor.room} (Cap: ??)`; 
            }
          }

          cell.className = 'occupied-cell';
          cell.innerHTML = `
            <div class="schedule-info">
              <div class="instructor">${scheduledInstructor.name}</div>
              <div class="subject">${scheduledInstructor.subject}</div>
              <div class="room">${roomDisplay}</div>
            </div>
          `;
        }
      }

      row.appendChild(cell);
    });

    scheduleBody.appendChild(row);
  });
}

function updateSelectionSummary() {
  const course = courseSelect.value;
  const year = yearSelect.value;
  const section = sectionSelect.value;

  if (course && year && section) {
    const formattedYear = year === '1st' ? '1' : 
                         year === '2nd' ? '2' : 
                         year === '3rd' ? '3' : '4';
    const combinedKey = `${course}-${formattedYear}${section}`;
    
    const studentCapacity = studentCapacityMap[combinedKey] || '---';
    
    courseSummary.textContent = combinedKey;
    studentCapacityDisplay.textContent = studentCapacity;
  } else {
    courseSummary.textContent = '----';
    studentCapacityDisplay.textContent = '---';
  }

  autoFillSchedule();
}

// Course selection handler
courseSelect.addEventListener('change', function() {
  // Clear year and section selects
  yearSelect.innerHTML = '<option value="">-- Select Year --</option>';
  sectionSelect.innerHTML = '<option value="">-- Select Section --</option>';
  
  const selectedCourse = courseSelect.value;

  if (selectedCourse) {
    // Enable year select and populate with years
    yearSelect.disabled = false;
    const years = courseConfig[selectedCourse].years;
    years.forEach(year => {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      yearSelect.appendChild(option);
    });
    
    // Reset section select and disable it
    sectionSelect.disabled = true;
  } else {
    // Disable both selects if no course is selected
    yearSelect.disabled = true;
    sectionSelect.disabled = true;
  }

  // Update summary and schedule
  updateSelectionSummary();
});

// Year selection handler
yearSelect.addEventListener('change', function() {
  // Clear section select
  sectionSelect.innerHTML = '<option value="">-- Select Section --</option>';
  
  const selectedCourse = courseSelect.value;
  const selectedYear = yearSelect.value;

  if (selectedCourse && selectedYear) {
    // Enable section select and populate with sections
    sectionSelect.disabled = false;
    const sections = courseConfig[selectedCourse].sections[selectedYear];
    sections.forEach(section => {
      const option = document.createElement('option');
      option.value = section;
      option.textContent = section;
      sectionSelect.appendChild(option);
    });
  } else {
    // Disable section select if no year is selected
    sectionSelect.disabled = true;
  }

  // Update summary and schedule
  updateSelectionSummary();
});

// Section selection handler
sectionSelect.addEventListener('focus', function() {
  if (!yearSelect.value) {
    alert('Please select a Year first');
    yearSelect.focus();
  }
});

sectionSelect.addEventListener('change', function() {
  updateSelectionSummary();
  autoFillSchedule();
});

// Storage change handler
window.addEventListener('storage', function(e) {
  if (e.key === 'instructors') {
    autoFillSchedule();
  }
});

// Initialize schedule
document.addEventListener('DOMContentLoaded', function() {
  autoFillSchedule();
});

  </script>
</body>
</html>
