<!DOCTYPE html>
<html>
<head>
  <title>DHVSU Scheduling System</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h2>DHVSU Automatic Scheduling System</h2>
  
  <div class="form-group">
    <label for="course">Select Course:</label> 
    <select id="course">
      <option value="">-- Select Course --</option>
    </select>
  </div>

  <div class="form-group">
    <label for="year">Select Year:</label> 
    <select id="year" disabled>
      <option value="">-- Select Year --</option>
    </select>
  </div>

  <div class="form-group">
    <label for="section">Select Section:</label> 
    <select id="section" disabled>
      <option value="">-- Select Section --</option>
    </select>
  </div>

  <div id="selectionSummary" class="summary">
    <span id="courseSummary">----</span>
    <span>Students Capacity:</span>
    <span id="studentCapacityDisplay">---</span>
    <span>Students</span>
  </div>

  <div id="scheduleContainer">
    <h3>Class Schedule</h3>
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>Monday</th>
          <th>Tuesday</th>
          <th>Wednesday</th>
          <th>Thursday</th>
          <th>Friday</th>
          <th>Saturday</th>
        </tr>
      </thead>
      <tbody id="scheduleBody">
      </tbody>
    </table>
  </div>

  <div class="navigation">
    <button onclick="navigateTo('instructor.html')">Instructor Enrollment</button>
    <button onclick="navigateTo('room.html')">Room Registration</button>
  </div>

  <script src="data.js"></script>
  <script src="schedule.js"></script>
  <script>
    // ... existing code ...
// DOM Element Selections
const courseSelect = document.getElementById('course');
const yearSelect = document.getElementById('year');
const sectionSelect = document.getElementById('section');
const courseSummary = document.getElementById('courseSummary');
const studentCapacityDisplay = document.getElementById('studentCapacityDisplay');
const scheduleBody = document.getElementById('scheduleBody');

// --- DATA (Assuming data.js provides courseConfig and studentCapacityMap) ---
// These would typically be in data.js and linked in Index.html before schedule.js
// For example:
// const courseConfig = { ... };
// const studentCapacityMap = { ... };

// --- NAVIGATION ---
function navigateTo(page) {
  try {
    window.location.href = page;
  } catch (error) {
    console.error('Navigation error:', error);
    alert('Unable to navigate. Please check the page exists.');
  }
}

// --- SCHEDULE GENERATION ---
function generateTimeSlots() {
  return [
    '7:00-8:00', '8:00-9:00', '9:00-10:00', '10:00-11:00',
    '11:00-12:00', '12:00-13:00', '13:00-14:00', '14:00-15:00',
    '15:00-16:00', '16:00-17:00', '17:00-18:00', '18:00-19:00'
  ];
}

function autoFillSchedule() {
  const timeSlots = generateTimeSlots();
  const selectedCourse = courseSelect.value;
  const selectedYear = yearSelect.value;
  const selectedSection = sectionSelect.value;
  
  scheduleBody.innerHTML = ''; // Clear existing schedule

  // Get data from localStorage
  const instructors = JSON.parse(localStorage.getItem('instructors')) || [];
  const roomsData = JSON.parse(localStorage.getItem('rooms')) || []; // Fetch rooms data

  timeSlots.forEach(timeSlot => {
    const row = document.createElement('tr');
    const [startTimeStr] = timeSlot.split('-'); // e.g., "7:00"
    
    row.innerHTML = `<td>${timeSlot}</td>`; // Time slot cell

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    days.forEach(day => {
      const cell = document.createElement('td');

      if (selectedCourse && selectedYear && selectedSection) {
        const scheduledInstructor = instructors.find(instructor => {
          if (instructor.course !== selectedCourse ||
              instructor.year !== selectedYear ||
              instructor.section !== selectedSection ||
              instructor.day !== day) {
            return false;
          }

          // Parse instructor's time range (e.g., "7:00 - 9:00")
          const [instrStartTimeStr, instrEndTimeStr] = instructor.time.split(' - ');
          const instrStartHour = parseInt(instrStartTimeStr.split(':')[0]);
          const instrEndHour = parseInt(instrEndTimeStr.split(':')[0]);
          const currentSlotStartHour = parseInt(startTimeStr.split(':')[0]);

          // Check if the current time slot's start hour falls within the instructor's scheduled hours
          return currentSlotStartHour >= instrStartHour && currentSlotStartHour < instrEndHour;
        });

        if (scheduledInstructor) { 
          let roomDisplay = 'TBA'; // Default to TBA

          if (scheduledInstructor.room && scheduledInstructor.room.trim() !== '') {
            const roomDetail = roomsData.find(r => r.roomName === scheduledInstructor.room);
            if (roomDetail) {
              roomDisplay = `${roomDetail.roomName} (Cap: ${roomDetail.capacity || 'N/A'})`;
            } else {
              roomDisplay = `${scheduledInstructor.room} (Cap: ??)`; 
            }
          }

          cell.className = 'occupied-cell';
          cell.innerHTML = `
            <div class="schedule-info">
              <div class="instructor">${scheduledInstructor.name}</div>
              <div class="subject">${scheduledInstructor.subject}</div>
              <div class="room">${roomDisplay}</div>
            </div>
          `;
        } 
      }
      row.appendChild(cell);
    });
    scheduleBody.appendChild(row);
  });
}

// --- UI UPDATES & EVENT LISTENERS ---
function updateSelectionSummary() {
  const course = courseSelect.value;
  const year = yearSelect.value;
  const section = sectionSelect.value;

  if (course && year && section) {
    // Assuming studentCapacityMap and courseConfig are globally available from data.js
    const formattedYear = year === '1st' ? '1' : 
                         year === '2nd' ? '2' : 
                         year === '3rd' ? '3' : '4'; // Adjust if year format differs
    const combinedKey = `${course}-${formattedYear}${section}`;
    
    const studentCapacity = studentCapacityMap[combinedKey] || '---';
    
    courseSummary.textContent = combinedKey;
    studentCapacityDisplay.textContent = studentCapacity;
  } else {
    courseSummary.textContent = '----';
    studentCapacityDisplay.textContent = '---';
  }
  autoFillSchedule(); // Refresh schedule whenever summary changes
}

// Course selection handler
if (courseSelect) {
  courseSelect.addEventListener('change', function() {
    yearSelect.innerHTML = '<option value="">-- Select Year --</option>';
    sectionSelect.innerHTML = '<option value="">-- Select Section --</option>';
    
    const selectedCourse = courseSelect.value;

    if (selectedCourse && courseConfig && courseConfig[selectedCourse]) {
      yearSelect.disabled = false;
      const years = courseConfig[selectedCourse].years;
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      });
      sectionSelect.disabled = true;
    } else {
      yearSelect.disabled = true;
      sectionSelect.disabled = true;
    }
    updateSelectionSummary();
  });
}

// Year selection handler
if (yearSelect) {
  yearSelect.addEventListener('change', function() {
    sectionSelect.innerHTML = '<option value="">-- Select Section --</option>';
    
    const selectedCourse = courseSelect.value;
    const selectedYear = yearSelect.value;

    if (selectedCourse && selectedYear && courseConfig && courseConfig[selectedCourse] && courseConfig[selectedCourse].sections[selectedYear]) {
      sectionSelect.disabled = false;
      const sections = courseConfig[selectedCourse].sections[selectedYear];
      sections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = section;
        sectionSelect.appendChild(option);
      });
    } else {
      sectionSelect.disabled = true;
    }
    updateSelectionSummary();
  });
}

// Section selection handler
if (sectionSelect) {
  sectionSelect.addEventListener('focus', function() {
    if (!yearSelect.value && !courseSelect.value) {
        alert('Please select a Course and Year first');
        courseSelect.focus();
    } else if (!yearSelect.value) {
        alert('Please select a Year first');
        yearSelect.focus();
    }
  });

  sectionSelect.addEventListener('change', function() {
    updateSelectionSummary(); 
    // autoFillSchedule is called by updateSelectionSummary, so not strictly needed here again
  });
}

// Storage change handler - refresh schedule if instructors data changes
window.addEventListener('storage', function(e) {
  if (e.key === 'instructors' || e.key === 'rooms') { // Also refresh if rooms data changes
    autoFillSchedule();
  }
});

// Initial population of dropdowns and schedule
document.addEventListener('DOMContentLoaded', function() {
  // Populate Course Select initially (assuming courseConfig is available)
  if (courseSelect && typeof courseConfig !== 'undefined') {
    for (const courseCode in courseConfig) {
      const option = document.createElement('option');
      option.value = courseCode;
      option.textContent = courseConfig[courseCode].name; // Or just courseCode if name isn't in config
      courseSelect.appendChild(option);
    }
  }
  // Initial call to fill schedule (will be empty if no selections)
  autoFillSchedule(); 
  // Initial call to set summary (will be default if no selections)
  updateSelectionSummary(); 
});

  </script>
</body>
</html>
