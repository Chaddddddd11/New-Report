<!DOCTYPE html>
<html>
<head>
  <title>DHVSU Scheduling System</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Your existing CSS styles */
    :root {
      --primary-color: #1A5F7A;
      --secondary-color: #2C8EBB;
      --accent-color: #F7B32D;
      --background-color: #F4F7F6;
      --text-color: #333;
    }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--background-color);
    }

    /* Add your other CSS styles here */
  </style>
</head>
<body>
  <div class="container">
    <h2>Class Schedule</h2>
    
    <!-- Your HTML content here -->
    <div class="filters">
      <select id="courseSelect">
        <option value="">Select Course</option>
        <option value="BSA">BSA</option>
        <option value="BSAIS">BSAIS</option>
        <!-- Add more courses as needed -->
      </select>
      
      <select id="yearSelect" disabled>
        <option value="">Select Year</option>
      </select>
      
      <select id="sectionSelect" disabled>
        <option value="">Select Section</option>
      </select>
    </div>
    
    <div class="schedule-container">
      <table id="scheduleTable">
        <thead>
          <tr>
            <th>Time</th>
            <th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
            <th>Saturday</th>
          </tr>
        </thead>
        <tbody id="scheduleBody">
          <!-- Schedule will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase and other scripts -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      onSnapshot, 
      query, 
      where, 
      getDocs,
      limit,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDeqxzp_-kKjM3hPr6CLGfTn38e4swSKbo",
      authDomain: "room-management-system-8e899.firebaseapp.com",
      projectId: "room-management-system-8e899",
      storageBucket: "room-management-system-8e899.firebasestorage.app",
      messagingSenderId: "667821278853",
      appId: "1:667821278853:web:a3a80c985073772670cbec"
    };

    // Initialize Firebase
    let app;
    let db;
    let instructorsCollectionRef;
    let allInstructorsData = [];
    
    try {
      console.log('Initializing Firebase with config:', firebaseConfig);
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      
      // Make db available globally for debugging
      window.db = db;
      
      // Collection reference with correct case sensitivity
      instructorsCollectionRef = collection(db, 'Instructors');
      window.instructorsCollectionRef = instructorsCollectionRef;
      
      window.firebaseInitialized = true;
      console.log('Firebase initialized successfully');
      
      // Set up the real-time listener
      setupFirebaseListener();
      
    } catch (error) {
      console.error('Failed to initialize Firebase:', error);
      alert('Failed to initialize Firebase. Please check the console for details.');
    }

    // DOM Elements
    const courseSelect = document.getElementById('courseSelect');
    const yearSelect = document.getElementById('yearSelect');
    const sectionSelect = document.getElementById('sectionSelect');
    const scheduleBody = document.getElementById('scheduleBody');

    // Set up real-time listener for instructors
    function setupFirebaseListener() {
      console.log('Setting up Firebase listener...');
      
      if (!db || !instructorsCollectionRef) {
        console.error('Firebase not properly initialized. Cannot set up listener.');
        return () => {}; // Return empty cleanup function
      }
      
      try {
        console.log('Creating query for collection...');
        const q = query(instructorsCollectionRef);
        console.log('Query created, setting up onSnapshot listener...');
        
        const unsubscribe = onSnapshot(q, 
          // Success callback
          (querySnapshot) => {
            console.log('Received data snapshot with', querySnapshot.size, 'documents');
            allInstructorsData = [];
            
            querySnapshot.forEach((doc) => {
              if (!doc.exists()) {
                console.warn('Document does not exist:', doc.id);
                return;
              }
              
              const data = doc.data();
              if (!data) {
                console.warn('Document data is empty for document:', doc.id);
                return;
              }
              
              console.log('Processing document:', doc.id, data);
              
              // Normalize time format
              let normalizedTime = '';
              if (data.time) {
                try {
                  const times = data.time.split('-').map(part => {
                    const [h, m = '00'] = part.trim().split(':');
                    return `${h.padStart(2, '0')}:${m.padStart(2, '0')}`.substring(0, 5);
                  });
                  normalizedTime = times.join('-');
                } catch (error) {
                  console.error('Error normalizing time:', error, 'Time string was:', data.time);
                  normalizedTime = data.time; // Use original if normalization fails
                }
              }
              
              // Create instructor object with normalized data
              const instructor = {
                id: doc.id,
                name: data.name || 'N/A',
                subject: data.subject || 'N/A',
                roomName: data.roomName || 'TBA',
                day: data.day ? data.day.trim() : '',
                time: normalizedTime,
                course: data.course || '',
                year: data.year || '',
                section: data.section || ''
              };
              
              allInstructorsData.push(instructor);
              console.log('Added instructor:', instructor.name);
            });
            
            console.log('All instructors loaded. Total:', allInstructorsData.length);
            
            // If we have selections, re-render the schedule
            if (courseSelect.value && yearSelect.value && sectionSelect.value) {
              renderSchedule();
            }
          },
          // Error callback
          (error) => {
            console.error('Error in Firestore listener:', error);
          }
        );
        
        return unsubscribe;
        
      } catch (error) {
        console.error('Error setting up Firestore listener:', error);
        return () => {}; // Return empty cleanup function
      }
    }

    // Function to normalize time format
    function normalizeTime(timeStr) {
      if (!timeStr) return '';
      
      // Handle time range format (e.g., "7:00 AM - 8:00 AM" or "07:00-08:00")
      if (timeStr.includes('-')) {
        const [start, end] = timeStr.split('-').map(s => s.trim());
        const startTime = formatTimeString(start);
        const endTime = formatTimeString(end);
        return `${startTime}-${endTime}`;
      }
      
      // Handle single time format (e.g., "7:00" or "7:00 AM")
      return formatTimeString(timeStr);
    }
    
    function formatTimeString(timeStr) {
      // Remove AM/PM if present
      timeStr = timeStr.replace(/\s*[AP]M\s*/i, '').trim();
      
      // Format as HH:MM
      const [h, m = '00'] = timeStr.split(':');
      return `${h.padStart(2, '0')}:${m.padStart(2, '0')}`;
    }

    // Function to update available years based on selected course
    function updateYearOptions() {
      const selectedCourse = courseSelect.value;
      yearSelect.innerHTML = '<option value="">Select Year</option>';
      yearSelect.disabled = !selectedCourse;
      
      if (!selectedCourse) {
        sectionSelect.innerHTML = '<option value="">Select Section</option>';
        sectionSelect.disabled = true;
        return;
      }
      
      // Add year options based on the selected course
      const years = ['1st', '2nd', '3rd', '4th', '5th'];
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + ' Year';
        yearSelect.appendChild(option);
      });
      
      // Reset section select
      sectionSelect.innerHTML = '<option value="">Select Section</option>';
      sectionSelect.disabled = true;
      
      // Clear the schedule
      scheduleBody.innerHTML = '';
    }

    // Function to update available sections based on selected year
    function updateSectionOptions() {
      const selectedCourse = courseSelect.value;
      const selectedYear = yearSelect.value;
      sectionSelect.innerHTML = '<option value="">Select Section</option>';
      sectionSelect.disabled = !selectedYear;
      
      if (!selectedYear) {
        return;
      }
      
      // Add section options (A, B, C, etc.)
      const sections = ['A', 'B', 'C', 'D'];
      sections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = 'Section ' + section;
        sectionSelect.appendChild(option);
      });
      
      // Clear the schedule
      scheduleBody.innerHTML = '';
    }

    // Function to render the schedule based on selected filters
    function renderSchedule() {
      console.log('Rendering schedule...');
      console.log('Total instructors in memory:', allInstructorsData.length);
      
      // Get selected values
      const selectedCourse = courseSelect.value;
      const selectedYear = yearSelect.value;
      const selectedSection = sectionSelect.value;
      
      console.log('Selected filters - Course:', selectedCourse, 'Year:', selectedYear, 'Section:', selectedSection);
      
      // Generate time slots from 07:00 to 17:00 (5:00 PM)
      const timeSlots = [];
      for (let i = 7; i < 17; i++) {
        const startHour = String(i).padStart(2, '0');
        const endHour = String(i + 1).padStart(2, '0');
        timeSlots.push(`${startHour}:00-${endHour}:00`);
      }
      
      // Clear the schedule body
      scheduleBody.innerHTML = '';
      
      // If any required filter is missing, show empty schedule
      if (!selectedCourse || !selectedYear || !selectedSection) {
        console.log('Missing filter criteria, showing empty schedule');
        timeSlots.forEach(timeSlot => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${timeSlot}</td><td></td><td></td><td></td><td></td><td></td><td></td>`;
          scheduleBody.appendChild(row);
        });
        return;
      }
      
      // Filter instructors for the selected course, year, and section
      console.log('Filtering instructors for:', { selectedCourse, selectedYear, selectedSection });
      
      const sectionInstructors = allInstructorsData.filter(instructor => {
        if (!instructor) return false;
        
        const courseMatch = String(instructor.course).toLowerCase() === String(selectedCourse).toLowerCase();
        const yearMatch = String(instructor.year).toLowerCase() === String(selectedYear).toLowerCase();
        const sectionMatch = String(instructor.section).toUpperCase() === String(selectedSection).toUpperCase();
        
        const isMatch = courseMatch && yearMatch && sectionMatch;
        
        if (isMatch) {
          console.log('Matching instructor:', {
            instructor,
            courseMatch,
            yearMatch,
            sectionMatch
          });
        }
        
        return isMatch;
      });
      
      console.log(`Found ${sectionInstructors.length} matching instructors:`, sectionInstructors);
      
      // Create a row for each time slot
      timeSlots.forEach(timeSlot => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${timeSlot}</td>`; // Add time slot cell
        
        // Days of the week
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        // Create a cell for each day
        days.forEach(day => {
          const cell = document.createElement('td');
          
          // Find matching instructor for this day and time
          const instructor = sectionInstructors.find(instr => {
            if (!instr.day || !instr.time) return false;
            
            // Normalize times for comparison
            const normalizedInstrTime = instr.time;
            const normalizedSlotTime = timeSlot;
            
            // Check if day and time match (case-insensitive day comparison)
            const dayMatch = instr.day.toLowerCase() === day.toLowerCase();
            const timeMatch = normalizedInstrTime === normalizedSlotTime;
            
            if (dayMatch && timeMatch) {
              console.log(`Match found: ${instr.name} on ${day} at ${timeSlot}`);
              return true;
            }
            
            return false;
          });
          
          // If instructor found, fill the cell with their info
          if (instructor) {
            cell.innerHTML = `
              <div class="schedule-entry">
                <div class="subject">${instructor.subject || 'N/A'}</div>
                <div class="instructor">${instructor.name || 'N/A'}</div>
                <div class="room">${instructor.roomName || 'TBA'}</div>
              </div>
            `;
          }
          
          row.appendChild(cell);
        });
        
        scheduleBody.appendChild(row);
      });
    }

    // Function to log current dropdown values and data for debugging
    function logCurrentState() {
      console.log('=== Current Application State ===');
      console.log('Selected Course:', courseSelect.value);
      console.log('Selected Year:', yearSelect.value);
      console.log('Selected Section:', sectionSelect.value);
      
      console.log('Available options:');
      console.log('- Courses:', Array.from(courseSelect.options).map(o => o.value));
      console.log('- Years:', Array.from(yearSelect.options).map(o => o.value));
      console.log('- Sections:', Array.from(sectionSelect.options).map(o => o.value));
      
      console.log('All instructors data:', allInstructorsData);
      console.log('===============================');
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM fully loaded, initializing application...');
      
      // Add event listeners for the dropdowns
      courseSelect.addEventListener('change', () => {
        console.log('Course changed to:', courseSelect.value);
        updateYearOptions();
        logCurrentState();
      });
      
      yearSelect.addEventListener('change', () => {
        console.log('Year changed to:', yearSelect.value);
        updateSectionOptions();
        logCurrentState();
      });
      
      sectionSelect.addEventListener('change', () => {
        console.log('Section changed to:', sectionSelect.value);
        renderSchedule();
        logCurrentState();
      });
      
      // Initial log
      logCurrentState();
    });
  </script>
</body>
</html>
